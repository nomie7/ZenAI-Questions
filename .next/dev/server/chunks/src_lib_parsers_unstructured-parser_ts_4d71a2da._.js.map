{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/External/dev/Projects/Work%20Projects/RAG/new_rag/questions/src/lib/parsers/unstructured-parser.ts"],"sourcesContent":["import type { DocumentParser, ParsedDocument, ParsedPage } from \"./index\";\n\n/**\n * Element returned by Unstructured API\n */\ninterface UnstructuredElement {\n  type: string;\n  element_id: string;\n  text: string;\n  metadata?: {\n    page_number?: number;\n    filename?: string;\n    filetype?: string;\n    languages?: string[];\n    [key: string]: unknown;\n  };\n}\n\n/**\n * Unstructured parser that calls a self-hosted Unstructured API.\n * Processes the entire document in a single API call.\n *\n * Env:\n * - UNSTRUCTURED_URL: base URL to Unstructured API (e.g., https://unstructured.example.com)\n * - UNSTRUCTURED_API_KEY: API key for authentication\n */\nexport class UnstructuredParser implements DocumentParser {\n  private baseUrl: string;\n  private apiKey: string;\n\n  constructor() {\n    this.baseUrl = process.env.UNSTRUCTURED_URL || \"\";\n    this.apiKey = process.env.UNSTRUCTURED_API_KEY || \"\";\n  }\n\n  async parse(file: Buffer, filename: string): Promise<ParsedDocument> {\n    if (!this.baseUrl) {\n      throw new Error(\n        \"UNSTRUCTURED_URL not set. Please configure the Unstructured API endpoint.\"\n      );\n    }\n\n    if (!this.apiKey) {\n      throw new Error(\n        \"UNSTRUCTURED_API_KEY not set. Please configure the API key.\"\n      );\n    }\n\n    const ext = filename.toLowerCase().split(\".\").pop();\n    if (ext !== \"pdf\") {\n      throw new Error(`Unsupported file type: ${ext}. Only PDF is supported.`);\n    }\n\n    console.log(`Processing document with Unstructured API: ${filename}`);\n\n    // Build form data\n    const formData = new FormData();\n    formData.append(\"files\", new Blob([new Uint8Array(file)]), filename);\n    formData.append(\"strategy\", \"hi_res\"); // High-resolution extraction\n\n    // Make API request\n    const response = await fetch(`${this.baseUrl}/general/v0/general`, {\n      method: \"POST\",\n      headers: {\n        accept: \"application/json\",\n        \"unstructured-api-key\": this.apiKey,\n      },\n      body: formData,\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(\n        `Unstructured API error: HTTP ${response.status}: ${errorText.slice(0, 500)}`\n      );\n    }\n\n    const elements = (await response.json()) as UnstructuredElement[];\n    console.log(`Received ${elements.length} elements from Unstructured API`);\n\n    // Group elements by page number\n    const pageMap = new Map<number, string[]>();\n\n    for (const element of elements) {\n      const pageNum = element.metadata?.page_number ?? 1;\n      if (!pageMap.has(pageNum)) {\n        pageMap.set(pageNum, []);\n      }\n      if (element.text && element.text.trim()) {\n        pageMap.get(pageNum)!.push(element.text.trim());\n      }\n    }\n\n    // Convert to pages array\n    const pages: ParsedPage[] = [];\n    const sortedPageNums = Array.from(pageMap.keys()).sort((a, b) => a - b);\n\n    for (const pageNum of sortedPageNums) {\n      const texts = pageMap.get(pageNum) || [];\n      pages.push({\n        pageNumber: pageNum,\n        text: texts.join(\"\\n\\n\"),\n        imageBuffer: undefined,\n      });\n    }\n\n    // Handle edge case: no pages extracted\n    if (pages.length === 0) {\n      console.warn(\"No pages extracted from document\");\n      pages.push({\n        pageNumber: 1,\n        text: \"[No text extracted from document]\",\n        imageBuffer: undefined,\n      });\n    }\n\n    console.log(`Successfully processed ${pages.length} pages`);\n\n    return {\n      pages,\n      metadata: {\n        pageCount: pages.length,\n        parserUsed: \"unstructured\",\n      },\n    };\n  }\n}\n"],"names":[],"mappings":";;;;AA0BO,MAAM;IACH,QAAgB;IAChB,OAAe;IAEvB,aAAc;QACZ,IAAI,CAAC,OAAO,GAAG,QAAQ,GAAG,CAAC,gBAAgB,IAAI;QAC/C,IAAI,CAAC,MAAM,GAAG,QAAQ,GAAG,CAAC,oBAAoB,IAAI;IACpD;IAEA,MAAM,MAAM,IAAY,EAAE,QAAgB,EAA2B;QACnE,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE;YACjB,MAAM,IAAI,MACR;QAEJ;QAEA,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;YAChB,MAAM,IAAI,MACR;QAEJ;QAEA,MAAM,MAAM,SAAS,WAAW,GAAG,KAAK,CAAC,KAAK,GAAG;QACjD,IAAI,QAAQ,OAAO;YACjB,MAAM,IAAI,MAAM,CAAC,uBAAuB,EAAE,IAAI,wBAAwB,CAAC;QACzE;QAEA,QAAQ,GAAG,CAAC,CAAC,2CAA2C,EAAE,UAAU;QAEpE,kBAAkB;QAClB,MAAM,WAAW,IAAI;QACrB,SAAS,MAAM,CAAC,SAAS,IAAI,KAAK;YAAC,IAAI,WAAW;SAAM,GAAG;QAC3D,SAAS,MAAM,CAAC,YAAY,WAAW,6BAA6B;QAEpE,mBAAmB;QACnB,MAAM,WAAW,MAAM,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,mBAAmB,CAAC,EAAE;YACjE,QAAQ;YACR,SAAS;gBACP,QAAQ;gBACR,wBAAwB,IAAI,CAAC,MAAM;YACrC;YACA,MAAM;QACR;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,YAAY,MAAM,SAAS,IAAI;YACrC,MAAM,IAAI,MACR,CAAC,6BAA6B,EAAE,SAAS,MAAM,CAAC,EAAE,EAAE,UAAU,KAAK,CAAC,GAAG,MAAM;QAEjF;QAEA,MAAM,WAAY,MAAM,SAAS,IAAI;QACrC,QAAQ,GAAG,CAAC,CAAC,SAAS,EAAE,SAAS,MAAM,CAAC,+BAA+B,CAAC;QAExE,gCAAgC;QAChC,MAAM,UAAU,IAAI;QAEpB,KAAK,MAAM,WAAW,SAAU;YAC9B,MAAM,UAAU,QAAQ,QAAQ,EAAE,eAAe;YACjD,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU;gBACzB,QAAQ,GAAG,CAAC,SAAS,EAAE;YACzB;YACA,IAAI,QAAQ,IAAI,IAAI,QAAQ,IAAI,CAAC,IAAI,IAAI;gBACvC,QAAQ,GAAG,CAAC,SAAU,IAAI,CAAC,QAAQ,IAAI,CAAC,IAAI;YAC9C;QACF;QAEA,yBAAyB;QACzB,MAAM,QAAsB,EAAE;QAC9B,MAAM,iBAAiB,MAAM,IAAI,CAAC,QAAQ,IAAI,IAAI,IAAI,CAAC,CAAC,GAAG,IAAM,IAAI;QAErE,KAAK,MAAM,WAAW,eAAgB;YACpC,MAAM,QAAQ,QAAQ,GAAG,CAAC,YAAY,EAAE;YACxC,MAAM,IAAI,CAAC;gBACT,YAAY;gBACZ,MAAM,MAAM,IAAI,CAAC;gBACjB,aAAa;YACf;QACF;QAEA,uCAAuC;QACvC,IAAI,MAAM,MAAM,KAAK,GAAG;YACtB,QAAQ,IAAI,CAAC;YACb,MAAM,IAAI,CAAC;gBACT,YAAY;gBACZ,MAAM;gBACN,aAAa;YACf;QACF;QAEA,QAAQ,GAAG,CAAC,CAAC,uBAAuB,EAAE,MAAM,MAAM,CAAC,MAAM,CAAC;QAE1D,OAAO;YACL;YACA,UAAU;gBACR,WAAW,MAAM,MAAM;gBACvB,YAAY;YACd;QACF;IACF;AACF"}}]
}