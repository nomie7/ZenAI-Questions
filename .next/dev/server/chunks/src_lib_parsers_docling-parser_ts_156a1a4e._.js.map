{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/External/dev/Projects/Work%20Projects/RAG/new_rag/questions/src/lib/parsers/docling-parser.ts"],"sourcesContent":["import type { DocumentParser, ParsedDocument, ParsedPage } from \"./index\";\n\n/**\n * Docling parser that calls a running docling-serve instance.\n * Throws an error if the service is unreachable or not configured.\n *\n * Env:\n * - DOCLING_SERVE_URL: full URL to docling-serve /v1/convert/file endpoint\n */\nexport class DoclingParser implements DocumentParser {\n  async parse(file: Buffer, filename: string): Promise<ParsedDocument> {\n    const endpoint =\n      process.env.DOCLING_SERVE_URL ||\n      process.env.DOCLING_ENDPOINT ||\n      \"\";\n\n    if (!endpoint) {\n      throw new Error(\n        \"DOCLING_SERVE_URL not set. Please configure the docling-serve endpoint.\"\n      );\n    }\n\n    try {\n      const formData = new FormData();\n      // docling-serve expects \"files\" (plural)\n      formData.append(\"files\", new Blob([file]), filename);\n\n      const response = await fetch(endpoint, {\n        method: \"POST\",\n        body: formData,\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(\n          `Docling-serve responded with status ${response.status}: ${errorText}`\n        );\n      }\n\n      const data = (await response.json()) as Record<string, unknown>;\n\n      // docling-serve returns { document: { md_content, pages, ... } } or { documents: [...] }\n      const doc = (data.document as Record<string, unknown>) ||\n                  ((data.documents as Record<string, unknown>[])?.[0]) ||\n                  data;\n\n      // Extract markdown content or text\n      const mdContent = (doc.md_content as string) ||\n                       (doc.text as string) ||\n                       (doc.content as string) ||\n                       \"\";\n\n      // Try to get pages array, or create single page from markdown\n      const rawPages = (doc.pages as unknown[]) || [];\n\n      let pages: ParsedPage[];\n\n      if (rawPages.length > 0) {\n        pages = rawPages.map((p: unknown, idx: number) => {\n          const page = p as Record<string, unknown>;\n          return {\n            pageNumber: Number(page.page_no ?? page.pageNumber ?? page.page ?? idx + 1) || idx + 1,\n            text: (page.text as string) || (page.content as string) || (page.md_content as string) || \"\",\n            imageBuffer: undefined,\n          };\n        });\n      } else if (mdContent) {\n        // If no pages array but we have markdown, split by page breaks or treat as single page\n        const pageTexts = mdContent.split(/<!-- page-break -->|\\n---\\n/).filter(Boolean);\n        pages = pageTexts.map((text, idx) => ({\n          pageNumber: idx + 1,\n          text: text.trim(),\n          imageBuffer: undefined,\n        }));\n      } else {\n        pages = [];\n      }\n\n      return {\n        pages,\n        metadata: {\n          pageCount: pages.length,\n          parserUsed: \"docling\",\n          title: (doc.title as string) || undefined,\n          author: (doc.author as string) || undefined,\n        },\n      };\n    } catch (error) {\n      throw new Error(\n        `Docling-serve failed: ${(error as Error).message}`\n      );\n    }\n  }\n}\n"],"names":[],"mappings":";;;;AASO,MAAM;IACX,MAAM,MAAM,IAAY,EAAE,QAAgB,EAA2B;QACnE,MAAM,WACJ,QAAQ,GAAG,CAAC,iBAAiB,IAC7B,QAAQ,GAAG,CAAC,gBAAgB,IAC5B;QAEF,IAAI,CAAC,UAAU;YACb,MAAM,IAAI,MACR;QAEJ;QAEA,IAAI;YACF,MAAM,WAAW,IAAI;YACrB,yCAAyC;YACzC,SAAS,MAAM,CAAC,SAAS,IAAI,KAAK;gBAAC;aAAK,GAAG;YAE3C,MAAM,WAAW,MAAM,MAAM,UAAU;gBACrC,QAAQ;gBACR,MAAM;YACR;YAEA,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,MAAM,YAAY,MAAM,SAAS,IAAI;gBACrC,MAAM,IAAI,MACR,CAAC,oCAAoC,EAAE,SAAS,MAAM,CAAC,EAAE,EAAE,WAAW;YAE1E;YAEA,MAAM,OAAQ,MAAM,SAAS,IAAI;YAEjC,yFAAyF;YACzF,MAAM,MAAM,AAAC,KAAK,QAAQ,IACZ,KAAK,SAAS,EAAgC,CAAC,EAAE,IACnD;YAEZ,mCAAmC;YACnC,MAAM,YAAY,AAAC,IAAI,UAAU,IACf,IAAI,IAAI,IACR,IAAI,OAAO,IACZ;YAEjB,8DAA8D;YAC9D,MAAM,WAAW,AAAC,IAAI,KAAK,IAAkB,EAAE;YAE/C,IAAI;YAEJ,IAAI,SAAS,MAAM,GAAG,GAAG;gBACvB,QAAQ,SAAS,GAAG,CAAC,CAAC,GAAY;oBAChC,MAAM,OAAO;oBACb,OAAO;wBACL,YAAY,OAAO,KAAK,OAAO,IAAI,KAAK,UAAU,IAAI,KAAK,IAAI,IAAI,MAAM,MAAM,MAAM;wBACrF,MAAM,AAAC,KAAK,IAAI,IAAgB,KAAK,OAAO,IAAgB,KAAK,UAAU,IAAe;wBAC1F,aAAa;oBACf;gBACF;YACF,OAAO,IAAI,WAAW;gBACpB,uFAAuF;gBACvF,MAAM,YAAY,UAAU,KAAK,CAAC,+BAA+B,MAAM,CAAC;gBACxE,QAAQ,UAAU,GAAG,CAAC,CAAC,MAAM,MAAQ,CAAC;wBACpC,YAAY,MAAM;wBAClB,MAAM,KAAK,IAAI;wBACf,aAAa;oBACf,CAAC;YACH,OAAO;gBACL,QAAQ,EAAE;YACZ;YAEA,OAAO;gBACL;gBACA,UAAU;oBACR,WAAW,MAAM,MAAM;oBACvB,YAAY;oBACZ,OAAO,AAAC,IAAI,KAAK,IAAe;oBAChC,QAAQ,AAAC,IAAI,MAAM,IAAe;gBACpC;YACF;QACF,EAAE,OAAO,OAAO;YACd,MAAM,IAAI,MACR,CAAC,sBAAsB,EAAE,AAAC,MAAgB,OAAO,EAAE;QAEvD;IACF;AACF"}}]
}