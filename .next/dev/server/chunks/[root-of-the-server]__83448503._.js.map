{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/External/dev/Projects/Work%20Projects/RAG/new_rag/questions/src/lib/parsers/unstructured-parser.ts"],"sourcesContent":["import { pdf } from \"pdf-to-img\";\nimport type { DocumentParser, ParsedDocument, ParsedPage } from \"./index\";\n\n/**\n * Element returned by Unstructured API\n */\ninterface UnstructuredElement {\n  type: string;\n  element_id: string;\n  text: string;\n  metadata?: {\n    page_number?: number;\n    filename?: string;\n    filetype?: string;\n    languages?: string[];\n    [key: string]: unknown;\n  };\n}\n\n/**\n * Supported file types for Unstructured API\n */\nconst SUPPORTED_EXTENSIONS = [\n  \"pdf\",\n  \"ppt\",\n  \"pptx\",\n  \"doc\",\n  \"docx\",\n  \"xls\",\n  \"xlsx\",\n  \"txt\",\n  \"md\",\n  \"html\",\n  \"htm\",\n  \"png\",\n  \"jpg\",\n  \"jpeg\",\n  \"tiff\",\n  \"bmp\",\n  \"heic\",\n];\n\n/**\n * Unstructured parser that calls a self-hosted Unstructured API.\n * Supports multiple document formats: PDF, PPT, DOCX, images, etc.\n * For PDFs, also extracts page images for visual citations.\n *\n * Env:\n * - UNSTRUCTURED_URL: base URL to Unstructured API\n * - UNSTRUCTURED_API_KEY: API key for authentication\n */\nexport class UnstructuredParser implements DocumentParser {\n  private baseUrl: string;\n  private apiKey: string;\n  private timeout: number;\n\n  constructor() {\n    this.baseUrl = process.env.UNSTRUCTURED_URL || \"\";\n    this.apiKey = process.env.UNSTRUCTURED_API_KEY || \"\";\n    // Timeout in ms (default 5 minutes for large documents)\n    this.timeout = Number(process.env.UNSTRUCTURED_TIMEOUT) || 300000;\n  }\n\n  async parse(file: Buffer, filename: string): Promise<ParsedDocument> {\n    if (!this.baseUrl) {\n      throw new Error(\n        \"UNSTRUCTURED_URL not set. Please configure the Unstructured API endpoint.\"\n      );\n    }\n\n    if (!this.apiKey) {\n      throw new Error(\n        \"UNSTRUCTURED_API_KEY not set. Please configure the API key.\"\n      );\n    }\n\n    const ext = filename.toLowerCase().split(\".\").pop() || \"\";\n    if (!SUPPORTED_EXTENSIONS.includes(ext)) {\n      throw new Error(\n        `Unsupported file type: ${ext}. Supported: ${SUPPORTED_EXTENSIONS.join(\", \")}`\n      );\n    }\n\n    const isPdf = ext === \"pdf\";\n    console.log(`Processing ${ext.toUpperCase()} with Unstructured API: ${filename}`);\n\n    // For PDFs, process page-by-page (avoids timeout on large docs)\n    if (isPdf) {\n      return this.processPdfPageByPage(file, filename);\n    }\n\n    // For other formats, process whole document\n    return this.processWholeDocument(file, filename);\n  }\n\n  /**\n   * Process PDF page-by-page to avoid timeouts on large documents\n   */\n  private async processPdfPageByPage(\n    file: Buffer,\n    filename: string\n  ): Promise<ParsedDocument> {\n    const pages: ParsedPage[] = [];\n    const errors: string[] = [];\n\n    // Extract page images\n    const pageImages = await this.extractPdfPageImages(file);\n    console.log(`Extracted ${pageImages.size} page images`);\n\n    if (pageImages.size === 0) {\n      throw new Error(\"Failed to extract any pages from PDF\");\n    }\n\n    // Process each page image through Unstructured\n    for (const [pageNum, imageBuffer] of pageImages) {\n      try {\n        console.log(`Processing page ${pageNum}/${pageImages.size}...`);\n\n        const elements = await this.callUnstructuredApi(\n          imageBuffer,\n          `page_${pageNum}.png`\n        );\n\n        const texts = elements\n          .filter((el) => el.text && el.text.trim())\n          .map((el) => el.text.trim());\n\n        pages.push({\n          pageNumber: pageNum,\n          text: texts.join(\"\\n\\n\") || `[No text extracted from page ${pageNum}]`,\n          imageBuffer,\n        });\n      } catch (error) {\n        const errorMsg = `Page ${pageNum}: ${(error as Error).message}`;\n        console.error(errorMsg);\n        errors.push(errorMsg);\n\n        // Add page with error note but keep the image\n        pages.push({\n          pageNumber: pageNum,\n          text: `[Error processing page ${pageNum}]`,\n          imageBuffer,\n        });\n      }\n    }\n\n    // Log summary\n    if (errors.length > 0) {\n      console.warn(`Completed with ${errors.length}/${pageImages.size} errors`);\n    } else {\n      console.log(`Successfully processed all ${pageImages.size} pages`);\n    }\n\n    return {\n      pages,\n      metadata: {\n        pageCount: pages.length,\n        parserUsed: \"unstructured\",\n      },\n    };\n  }\n\n  /**\n   * Process non-PDF documents as a whole\n   */\n  private async processWholeDocument(\n    file: Buffer,\n    filename: string\n  ): Promise<ParsedDocument> {\n    const elements = await this.callUnstructuredApi(file, filename);\n    console.log(`Received ${elements.length} elements from Unstructured API`);\n\n    // Group elements by page number\n    const pageMap = new Map<number, string[]>();\n\n    for (const element of elements) {\n      const pageNum = element.metadata?.page_number ?? 1;\n      if (!pageMap.has(pageNum)) {\n        pageMap.set(pageNum, []);\n      }\n      if (element.text && element.text.trim()) {\n        pageMap.get(pageNum)!.push(element.text.trim());\n      }\n    }\n\n    // Convert to pages array\n    const pages: ParsedPage[] = [];\n    const sortedPageNums = Array.from(pageMap.keys()).sort((a, b) => a - b);\n\n    for (const pageNum of sortedPageNums) {\n      const texts = pageMap.get(pageNum) || [];\n      pages.push({\n        pageNumber: pageNum,\n        text: texts.join(\"\\n\\n\"),\n        imageBuffer: undefined,\n      });\n    }\n\n    // Handle edge case\n    if (pages.length === 0) {\n      console.warn(\"No pages extracted from document\");\n      pages.push({\n        pageNumber: 1,\n        text: \"[No text extracted from document]\",\n        imageBuffer: undefined,\n      });\n    }\n\n    console.log(`Successfully processed ${pages.length} pages/slides`);\n\n    return {\n      pages,\n      metadata: {\n        pageCount: pages.length,\n        parserUsed: \"unstructured\",\n      },\n    };\n  }\n\n  /**\n   * Extract page images from PDF using pdf-to-img\n   */\n  private async extractPdfPageImages(file: Buffer): Promise<Map<number, Buffer>> {\n    const pageImages = new Map<number, Buffer>();\n\n    try {\n      const document = await pdf(file, { scale: 1.5 }); // Good balance of quality/size\n      let pageNumber = 0;\n\n      for await (const imageBuffer of document) {\n        pageNumber++;\n        pageImages.set(pageNumber, Buffer.from(imageBuffer));\n      }\n    } catch (error) {\n      console.warn(\"Failed to extract PDF page images:\", (error as Error).message);\n      // Continue without images - text extraction will still work\n    }\n\n    return pageImages;\n  }\n\n  /**\n   * Call Unstructured API with timeout handling\n   */\n  private async callUnstructuredApi(\n    file: Buffer,\n    filename: string\n  ): Promise<UnstructuredElement[]> {\n    // Build form data\n    const formData = new FormData();\n    formData.append(\"files\", new Blob([new Uint8Array(file)]), filename);\n    formData.append(\"strategy\", \"hi_res\"); // High-resolution extraction\n\n    // Create abort controller for timeout\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), this.timeout);\n\n    try {\n      const response = await fetch(`${this.baseUrl}/general/v0/general`, {\n        method: \"POST\",\n        headers: {\n          accept: \"application/json\",\n          \"unstructured-api-key\": this.apiKey,\n        },\n        body: formData,\n        signal: controller.signal,\n      });\n\n      clearTimeout(timeoutId);\n\n      if (!response.ok) {\n        const errorText = await response.text();\n\n        // Handle Cloudflare timeout specifically\n        if (response.status === 524) {\n          throw new Error(\n            `Document processing timed out (Cloudflare 524). The document may be too large. ` +\n            `Try a smaller document or increase server timeout.`\n          );\n        }\n\n        throw new Error(\n          `Unstructured API error: HTTP ${response.status}: ${errorText.slice(0, 300)}`\n        );\n      }\n\n      return (await response.json()) as UnstructuredElement[];\n    } catch (error) {\n      clearTimeout(timeoutId);\n\n      if ((error as Error).name === \"AbortError\") {\n        throw new Error(\n          `Document processing timed out after ${this.timeout / 1000}s. ` +\n          `Try a smaller document or increase UNSTRUCTURED_TIMEOUT.`\n        );\n      }\n\n      throw error;\n    }\n  }\n}\n"],"names":[],"mappings":"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"}}]
}