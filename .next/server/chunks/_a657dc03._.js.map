{"version":3,"sources":["../../../src/lib/parsers/gemini-parser.ts"],"sourcesContent":["import { GoogleGenerativeAI } from \"@google/generative-ai\";\nimport { pdf } from \"pdf-to-img\";\nimport type { DocumentParser, ParsedDocument, ParsedPage } from \"./index\";\n\n/**\n * Gemini Flash parser for advanced document understanding\n *\n * Good for: Scanned PDFs, complex layouts, handwritten notes, tables\n * Uses vision capabilities to extract text from page images\n */\nexport class GeminiParser implements DocumentParser {\n  private genAI: GoogleGenerativeAI;\n  private model;\n\n  constructor() {\n    const apiKey = process.env.GOOGLE_API_KEY;\n    if (!apiKey) {\n      throw new Error(\"GOOGLE_API_KEY is required for Gemini parser\");\n    }\n\n    this.genAI = new GoogleGenerativeAI(apiKey);\n    // Use Gemini 1.5 Flash for fast, cost-effective processing\n    this.model = this.genAI.getGenerativeModel({ model: \"gemini-1.5-flash\" });\n  }\n\n  async parse(file: Buffer, filename: string): Promise<ParsedDocument> {\n    const ext = filename.toLowerCase().split(\".\").pop();\n\n    if (ext !== \"pdf\") {\n      throw new Error(`Unsupported file type: ${ext}. Only PDF is supported.`);\n    }\n\n    const pages: ParsedPage[] = [];\n\n    try {\n      // Convert PDF pages to images\n      const document = await pdf(file, {\n        scale: 2.0, // Higher quality for better OCR\n      });\n\n      let pageNumber = 0;\n      for await (const imageBuffer of document) {\n        pageNumber++;\n\n        // Extract text using Gemini Vision\n        const text = await this.extractTextFromImage(\n          Buffer.from(imageBuffer),\n          pageNumber\n        );\n\n        pages.push({\n          pageNumber,\n          text,\n          imageBuffer: Buffer.from(imageBuffer),\n        });\n\n        // Small delay to avoid rate limiting\n        if (pageNumber > 1) {\n          await new Promise((resolve) => setTimeout(resolve, 200));\n        }\n      }\n\n      return {\n        pages,\n        metadata: {\n          pageCount: pages.length,\n          parserUsed: \"gemini\",\n        },\n      };\n    } catch (error) {\n      console.error(\"Error parsing PDF with Gemini:\", error);\n      throw new Error(\n        `Failed to parse PDF with Gemini: ${(error as Error).message}`\n      );\n    }\n  }\n\n  /**\n   * Extract text from a page image using Gemini Vision\n   */\n  private async extractTextFromImage(\n    imageBuffer: Buffer,\n    pageNumber: number\n  ): Promise<string> {\n    try {\n      const base64Image = imageBuffer.toString(\"base64\");\n\n      const result = await this.model.generateContent([\n        {\n          inlineData: {\n            mimeType: \"image/png\",\n            data: base64Image,\n          },\n        },\n        {\n          text: `Extract all text content from this document page (page ${pageNumber}).\n\nInstructions:\n- Extract ALL visible text, maintaining the reading order\n- Preserve paragraph structure with blank lines between sections\n- For tables, format as plain text with alignment\n- Include headers, footers, and any captions\n- If there are bullet points or numbered lists, preserve the formatting\n- Do not add any commentary, just return the extracted text\n- If there is no text visible, return \"[No text content on this page]\"`,\n        },\n      ]);\n\n      const response = await result.response;\n      const text = response.text();\n\n      return text.trim() || `[No text content on page ${pageNumber}]`;\n    } catch (error) {\n      console.error(`Error extracting text from page ${pageNumber}:`, error);\n      return `[Error extracting text from page ${pageNumber}]`;\n    }\n  }\n}\n"],"names":[],"mappings":"63kBAAA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,yCASO,OAAM,EACH,KAA0B,AAC1B,MAAM,AAEd,cAAc,CACZ,MAAM,EAAS,QAAQ,GAAG,CAAC,cAAc,CACzC,GAAI,CAAC,EACH,MADW,AACL,AAAI,MAAM,gDAGlB,IAAI,CAAC,KAAK,CAAG,IAAI,EAAA,kBAAkB,CAAC,GAEpC,IAAI,CAAC,KAAK,CAAG,IAAI,CAAC,KAAK,CAAC,kBAAkB,CAAC,CAAE,MAAO,kBAAmB,EACzE,CAEA,MAAM,MAAM,CAAY,CAAE,CAAgB,CAA2B,CACnE,IAAM,EAAM,EAAS,WAAW,GAAG,KAAK,CAAC,KAAK,GAAG,GAEjD,GAAY,OAAO,CAAf,EACF,MAAM,AAAI,MAAM,CAAC,uBAAuB,EAAE,EAAI,wBAAwB,CAAC,EAGzE,IAAM,EAAsB,EAAE,CAE9B,GAAI,CAEF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,GAAG,AAAH,EAAI,EAAM,CAC/B,MAAO,CACT,GAEI,EAAa,EACjB,UAAW,IAAM,KAAe,EAAU,CACxC,IAGA,IAAM,EAAO,MAAM,IAAI,CAAC,oBAAoB,CAC1C,OAAO,IAAI,CAAC,GACZ,GAGF,EAAM,IAAI,CAAC,YACT,OACA,EACA,YAAa,OAAO,IAAI,CAAC,EAC3B,GAGI,EAAa,GAAG,AAClB,MAAM,IAAI,QAAQ,AAAC,GAAY,WAAW,EAAS,KAEvD,CAEA,MAAO,OACL,EACA,SAAU,CACR,UAAW,EAAM,MAAM,CACvB,WAAY,QACd,CACF,CACF,CAAE,MAAO,EAAO,CAEd,MADA,QAAQ,KAAK,CAAC,iCAAkC,GAC1C,AAAI,MACR,CAAC,iCAAiC,EAAG,EAAgB,OAAO,CAAA,CAAE,CAElE,CACF,CAKA,MAAc,qBACZ,CAAmB,CACnB,CAAkB,CACD,CACjB,GAAI,CACF,IAAM,EAAc,EAAY,QAAQ,CAAC,UAEnC,EAAS,MAAM,IAAI,CAAC,KAAK,CAAC,eAAe,CAAC,CAC9C,CACE,WAAY,CACV,SAAU,YACV,KAAM,CACR,CACF,EACA,CACE,KAAM,CAAC,uDAAuD,EAAE,EAAW;;;;;;;;;sEASf,CAAC,AAC/D,EACD,EAKD,MAFa,AAEN,CAHU,MAAM,EAAO,QAAA,AAAQ,EAChB,IAAI,GAEd,IAAI,IAAM,CAAC,yBAAyB,EAAE,EAAW,CAAC,CAAC,AACjE,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,CAAC,gCAAgC,EAAE,EAAW,CAAC,CAAC,CAAE,GACzD,CAAC,iCAAiC,EAAE,EAAW,CAAC,CAAC,AAC1D,CACF,CACF"}