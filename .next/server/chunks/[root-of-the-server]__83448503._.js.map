{"version":3,"sources":["../../../src/lib/parsers/unstructured-parser.ts"],"sourcesContent":["import { pdf } from \"pdf-to-img\";\nimport type { DocumentParser, ParsedDocument, ParsedPage } from \"./index\";\n\n/**\n * Element returned by Unstructured API\n */\ninterface UnstructuredElement {\n  type: string;\n  element_id: string;\n  text: string;\n  metadata?: {\n    page_number?: number;\n    filename?: string;\n    filetype?: string;\n    languages?: string[];\n    [key: string]: unknown;\n  };\n}\n\n/**\n * Supported file types for Unstructured API\n */\nconst SUPPORTED_EXTENSIONS = [\n  \"pdf\",\n  \"ppt\",\n  \"pptx\",\n  \"doc\",\n  \"docx\",\n  \"xls\",\n  \"xlsx\",\n  \"txt\",\n  \"md\",\n  \"html\",\n  \"htm\",\n  \"png\",\n  \"jpg\",\n  \"jpeg\",\n  \"tiff\",\n  \"bmp\",\n  \"heic\",\n];\n\n/**\n * Unstructured parser that calls a self-hosted Unstructured API.\n * Supports multiple document formats: PDF, PPT, DOCX, images, etc.\n * For PDFs, also extracts page images for visual citations.\n *\n * Env:\n * - UNSTRUCTURED_URL: base URL to Unstructured API\n * - UNSTRUCTURED_API_KEY: API key for authentication\n */\nexport class UnstructuredParser implements DocumentParser {\n  private baseUrl: string;\n  private apiKey: string;\n  private timeout: number;\n\n  constructor() {\n    this.baseUrl = process.env.UNSTRUCTURED_URL || \"\";\n    this.apiKey = process.env.UNSTRUCTURED_API_KEY || \"\";\n    // Timeout in ms (default 5 minutes for large documents)\n    this.timeout = Number(process.env.UNSTRUCTURED_TIMEOUT) || 300000;\n  }\n\n  async parse(file: Buffer, filename: string): Promise<ParsedDocument> {\n    if (!this.baseUrl) {\n      throw new Error(\n        \"UNSTRUCTURED_URL not set. Please configure the Unstructured API endpoint.\"\n      );\n    }\n\n    if (!this.apiKey) {\n      throw new Error(\n        \"UNSTRUCTURED_API_KEY not set. Please configure the API key.\"\n      );\n    }\n\n    const ext = filename.toLowerCase().split(\".\").pop() || \"\";\n    if (!SUPPORTED_EXTENSIONS.includes(ext)) {\n      throw new Error(\n        `Unsupported file type: ${ext}. Supported: ${SUPPORTED_EXTENSIONS.join(\", \")}`\n      );\n    }\n\n    const isPdf = ext === \"pdf\";\n    console.log(`Processing ${ext.toUpperCase()} with Unstructured API: ${filename}`);\n\n    // For PDFs, process page-by-page (avoids timeout on large docs)\n    if (isPdf) {\n      return this.processPdfPageByPage(file, filename);\n    }\n\n    // For other formats, process whole document\n    return this.processWholeDocument(file, filename);\n  }\n\n  /**\n   * Process PDF page-by-page to avoid timeouts on large documents\n   */\n  private async processPdfPageByPage(\n    file: Buffer,\n    filename: string\n  ): Promise<ParsedDocument> {\n    const pages: ParsedPage[] = [];\n    const errors: string[] = [];\n\n    // Extract page images\n    const pageImages = await this.extractPdfPageImages(file);\n    console.log(`Extracted ${pageImages.size} page images`);\n\n    if (pageImages.size === 0) {\n      throw new Error(\"Failed to extract any pages from PDF\");\n    }\n\n    // Process each page image through Unstructured\n    for (const [pageNum, imageBuffer] of pageImages) {\n      try {\n        console.log(`Processing page ${pageNum}/${pageImages.size}...`);\n\n        const elements = await this.callUnstructuredApi(\n          imageBuffer,\n          `page_${pageNum}.png`\n        );\n\n        const texts = elements\n          .filter((el) => el.text && el.text.trim())\n          .map((el) => el.text.trim());\n\n        pages.push({\n          pageNumber: pageNum,\n          text: texts.join(\"\\n\\n\") || `[No text extracted from page ${pageNum}]`,\n          imageBuffer,\n        });\n      } catch (error) {\n        const errorMsg = `Page ${pageNum}: ${(error as Error).message}`;\n        console.error(errorMsg);\n        errors.push(errorMsg);\n\n        // Add page with error note but keep the image\n        pages.push({\n          pageNumber: pageNum,\n          text: `[Error processing page ${pageNum}]`,\n          imageBuffer,\n        });\n      }\n    }\n\n    // Log summary\n    if (errors.length > 0) {\n      console.warn(`Completed with ${errors.length}/${pageImages.size} errors`);\n    } else {\n      console.log(`Successfully processed all ${pageImages.size} pages`);\n    }\n\n    return {\n      pages,\n      metadata: {\n        pageCount: pages.length,\n        parserUsed: \"unstructured\",\n      },\n    };\n  }\n\n  /**\n   * Process non-PDF documents as a whole\n   */\n  private async processWholeDocument(\n    file: Buffer,\n    filename: string\n  ): Promise<ParsedDocument> {\n    const elements = await this.callUnstructuredApi(file, filename);\n    console.log(`Received ${elements.length} elements from Unstructured API`);\n\n    // Group elements by page number\n    const pageMap = new Map<number, string[]>();\n\n    for (const element of elements) {\n      const pageNum = element.metadata?.page_number ?? 1;\n      if (!pageMap.has(pageNum)) {\n        pageMap.set(pageNum, []);\n      }\n      if (element.text && element.text.trim()) {\n        pageMap.get(pageNum)!.push(element.text.trim());\n      }\n    }\n\n    // Convert to pages array\n    const pages: ParsedPage[] = [];\n    const sortedPageNums = Array.from(pageMap.keys()).sort((a, b) => a - b);\n\n    for (const pageNum of sortedPageNums) {\n      const texts = pageMap.get(pageNum) || [];\n      pages.push({\n        pageNumber: pageNum,\n        text: texts.join(\"\\n\\n\"),\n        imageBuffer: undefined,\n      });\n    }\n\n    // Handle edge case\n    if (pages.length === 0) {\n      console.warn(\"No pages extracted from document\");\n      pages.push({\n        pageNumber: 1,\n        text: \"[No text extracted from document]\",\n        imageBuffer: undefined,\n      });\n    }\n\n    console.log(`Successfully processed ${pages.length} pages/slides`);\n\n    return {\n      pages,\n      metadata: {\n        pageCount: pages.length,\n        parserUsed: \"unstructured\",\n      },\n    };\n  }\n\n  /**\n   * Extract page images from PDF using pdf-to-img\n   */\n  private async extractPdfPageImages(file: Buffer): Promise<Map<number, Buffer>> {\n    const pageImages = new Map<number, Buffer>();\n\n    try {\n      const document = await pdf(file, { scale: 1.5 }); // Good balance of quality/size\n      let pageNumber = 0;\n\n      for await (const imageBuffer of document) {\n        pageNumber++;\n        pageImages.set(pageNumber, Buffer.from(imageBuffer));\n      }\n    } catch (error) {\n      console.warn(\"Failed to extract PDF page images:\", (error as Error).message);\n      // Continue without images - text extraction will still work\n    }\n\n    return pageImages;\n  }\n\n  /**\n   * Call Unstructured API with timeout handling\n   */\n  private async callUnstructuredApi(\n    file: Buffer,\n    filename: string\n  ): Promise<UnstructuredElement[]> {\n    // Build form data\n    const formData = new FormData();\n    formData.append(\"files\", new Blob([new Uint8Array(file)]), filename);\n    formData.append(\"strategy\", \"hi_res\"); // High-resolution extraction\n\n    // Create abort controller for timeout\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), this.timeout);\n\n    try {\n      const response = await fetch(`${this.baseUrl}/general/v0/general`, {\n        method: \"POST\",\n        headers: {\n          accept: \"application/json\",\n          \"unstructured-api-key\": this.apiKey,\n        },\n        body: formData,\n        signal: controller.signal,\n      });\n\n      clearTimeout(timeoutId);\n\n      if (!response.ok) {\n        const errorText = await response.text();\n\n        // Handle Cloudflare timeout specifically\n        if (response.status === 524) {\n          throw new Error(\n            `Document processing timed out (Cloudflare 524). The document may be too large. ` +\n            `Try a smaller document or increase server timeout.`\n          );\n        }\n\n        throw new Error(\n          `Unstructured API error: HTTP ${response.status}: ${errorText.slice(0, 300)}`\n        );\n      }\n\n      return (await response.json()) as UnstructuredElement[];\n    } catch (error) {\n      clearTimeout(timeoutId);\n\n      if ((error as Error).name === \"AbortError\") {\n        throw new Error(\n          `Document processing timed out after ${this.timeout / 1000}s. ` +\n          `Try a smaller document or increase UNSTRUCTURED_TIMEOUT.`\n        );\n      }\n\n      throw error;\n    }\n  }\n}\n"],"names":[],"mappings":"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"}