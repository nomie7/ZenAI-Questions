module.exports=[174340,e=>{"use strict";e.s([],663412),e.i(663412);var t,r,a,n,o=e.i(60400),i=e.i(792509),s=e.i(848979),c=e.i(500874),l=e.i(921517);function d(e){return new Promise((t,r)=>{let a=(0,l.request)({method:"GET",...e,hostname:e.hostname?.replace(/^\[(.+)\]$/,"$1")});a.on("error",e=>{r(Object.assign(new s.ProviderError("Unable to connect to instance metadata service"),e)),a.destroy()}),a.on("timeout",()=>{r(new s.ProviderError("TimeoutError from instance metadata service")),a.destroy()}),a.on("response",e=>{let{statusCode:n=400}=e;(n<200||300<=n)&&(r(Object.assign(new s.ProviderError("Error response received from instance metadata service"),{statusCode:n})),a.destroy());let o=[];e.on("data",e=>{o.push(e)}),e.on("end",()=>{t(c.Buffer.concat(o)),a.destroy()})}),a.end()})}let p=e=>!!e&&"object"==typeof e&&"string"==typeof e.AccessKeyId&&"string"==typeof e.SecretAccessKey&&"string"==typeof e.Token&&"string"==typeof e.Expiration,v=e=>({accessKeyId:e.AccessKeyId,secretAccessKey:e.SecretAccessKey,sessionToken:e.Token,expiration:new Date(e.Expiration),...e.AccountId&&{accountId:e.AccountId}}),E=1e3,u=0,f=({maxRetries:e=u,timeout:t=E})=>({maxRetries:e,timeout:t});e.s(["DEFAULT_MAX_RETRIES",0,u,"DEFAULT_TIMEOUT",0,E,"providerConfigFromInit",0,f],720695);let h=(e,t)=>{let r=e();for(let a=0;a<t;a++)r=r.catch(e);return r},m="AWS_CONTAINER_CREDENTIALS_FULL_URI",_="AWS_CONTAINER_CREDENTIALS_RELATIVE_URI",g="AWS_CONTAINER_AUTHORIZATION_TOKEN",I=(e={})=>{let{timeout:t,maxRetries:r}=f(e);return()=>h(async()=>{let r=await T({logger:e.logger}),a=JSON.parse(await w(t,r));if(!p(a))throw new o.CredentialsProviderError("Invalid response received from instance metadata service.",{logger:e.logger});return v(a)},r)},w=async(e,t)=>(process.env[g]&&(t.headers={...t.headers,Authorization:process.env[g]}),(await d({...t,timeout:e})).toString()),A={localhost:!0,"127.0.0.1":!0},y={"http:":!0,"https:":!0},T=async({logger:e})=>{if(process.env[_])return{hostname:"169.254.170.2",path:process.env[_]};if(process.env[m]){let t=(0,i.parse)(process.env[m]);if(!t.hostname||!(t.hostname in A))throw new o.CredentialsProviderError(`${t.hostname} is not a valid container metadata service hostname`,{tryNextLink:!1,logger:e});if(!t.protocol||!(t.protocol in y))throw new o.CredentialsProviderError(`${t.protocol} is not a valid container metadata service protocol`,{tryNextLink:!1,logger:e});return{...t,port:t.port?parseInt(t.port,10):void 0}}throw new o.CredentialsProviderError(`The container metadata credential provider cannot be used unless the ${_} or ${m} environment variable is set`,{tryNextLink:!1,logger:e})};e.s(["ENV_CMDS_AUTH_TOKEN",0,g,"ENV_CMDS_FULL_URI",0,m,"ENV_CMDS_RELATIVE_URI",0,_,"fromContainerMetadata",0,I],374340),e.i(374340);var S=e.i(415189),C=o;class D extends C.CredentialsProviderError{tryNextLink;name="InstanceMetadataV1FallbackError";constructor(e,t=!0){super(e,t),this.tryNextLink=t,Object.setPrototypeOf(this,D.prototype)}}var M=e.i(241175);(t=a||(a={})).IPv4="http://169.254.169.254",t.IPv6="http://[fd00:ec2::254]";let N={environmentVariableSelector:e=>e.AWS_EC2_METADATA_SERVICE_ENDPOINT,configFileSelector:e=>e.ec2_metadata_service_endpoint,default:void 0};(r=n||(n={})).IPv4="IPv4",r.IPv6="IPv6";let b={environmentVariableSelector:e=>e.AWS_EC2_METADATA_SERVICE_ENDPOINT_MODE,configFileSelector:e=>e.ec2_metadata_service_endpoint_mode,default:n.IPv4},P=async()=>(0,M.parseUrl)(await R()||await U()),R=async()=>(0,S.loadConfig)(N)(),U=async()=>{let e=await (0,S.loadConfig)(b)();switch(e){case n.IPv4:return a.IPv4;case n.IPv6:return a.IPv6;default:throw Error(`Unsupported endpoint mode: ${e}. Select from ${Object.values(n)}`)}},L=(e,t)=>{let r=300+Math.floor(300*Math.random()),a=new Date(Date.now()+1e3*r);t.warn(`Attempting credential expiration extension due to a credential service availability issue. A refresh of these credentials will be attempted after ${new Date(a)}.
For more information, please visit: https://docs.aws.amazon.com/sdkref/latest/guide/feature-static-credentials.html`);let n=e.originalExpiration??e.expiration;return{...e,...n?{originalExpiration:n}:{},expiration:a}},O="/latest/meta-data/iam/security-credentials/",k="AWS_EC2_METADATA_V1_DISABLED",x="ec2_metadata_v1_disabled",V="x-aws-ec2-metadata-token",F=(e={})=>((e,t={})=>{let r,a=t?.logger||console;return async()=>{let t;try{(t=await e()).expiration&&t.expiration.getTime()<Date.now()&&(t=L(t,a))}catch(e){if(r)a.warn("Credential renew failed: ",e),t=L(r,a);else throw e}return r=t,t}})($(e),{logger:e.logger}),$=(e={})=>{let t=!1,{logger:r,profile:a}=e,{timeout:n,maxRetries:i}=f(e),s=async(r,n)=>{if(t||n.headers?.[V]==null){let t=!1,r=!1,n=await (0,S.loadConfig)({environmentVariableSelector:t=>{let a=t[k];if(r=!!a&&"false"!==a,void 0===a)throw new o.CredentialsProviderError(`${k} not set in env, checking config file next.`,{logger:e.logger});return r},configFileSelector:e=>{let r=e[x];return t=!!r&&"false"!==r},default:!1},{profile:a})();if(e.ec2MetadataV1Disabled||n){let a=[];throw e.ec2MetadataV1Disabled&&a.push("credential provider initialization (runtime option ec2MetadataV1Disabled)"),t&&a.push(`config file profile (${x})`),r&&a.push(`process environment variable (${k})`),new D(`AWS EC2 Metadata v1 fallback has been blocked by AWS SDK configuration in the following: [${a.join(", ")}].`)}}let i=(await h(async()=>{let e;try{e=await W(n)}catch(e){throw 401===e.statusCode&&(t=!1),e}return e},r)).trim();return h(async()=>{let r;try{r=await j(i,n,e)}catch(e){throw 401===e.statusCode&&(t=!1),e}return r},r)};return async()=>{let e=await P();if(t)return r?.debug("AWS SDK Instance Metadata","using v1 fallback (no token fetch)"),s(i,{...e,timeout:n});{let a;try{a=(await K({...e,timeout:n})).toString()}catch(a){if(a?.statusCode===400)throw Object.assign(a,{message:"EC2 Metadata token request returned error"});return("TimeoutError"===a.message||[403,404,405].includes(a.statusCode))&&(t=!0),r?.debug("AWS SDK Instance Metadata","using v1 fallback (initial)"),s(i,{...e,timeout:n})}return s(i,{...e,headers:{[V]:a},timeout:n})}}},K=async e=>d({...e,path:"/latest/api/token",method:"PUT",headers:{"x-aws-ec2-metadata-token-ttl-seconds":"21600"}}),W=async e=>(await d({...e,path:O})).toString(),j=async(e,t,r)=>{let a=JSON.parse((await d({...t,path:O+e})).toString());if(!p(a))throw new o.CredentialsProviderError("Invalid response received from instance metadata service.",{logger:r.logger});return v(a)};e.s(["fromInstanceMetadata",0,F],482842),e.i(482842),e.i(720695),e.s([],695710),e.i(695710),e.s(["DEFAULT_MAX_RETRIES",0,u,"DEFAULT_TIMEOUT",0,E,"ENV_CMDS_AUTH_TOKEN",0,g,"ENV_CMDS_FULL_URI",0,m,"ENV_CMDS_RELATIVE_URI",0,_,"Endpoint",()=>a,"fromContainerMetadata",0,I,"fromInstanceMetadata",0,F,"getInstanceMetadataEndpoint",0,P,"httpRequest",()=>d,"providerConfigFromInit",0,f],174340)}];

//# sourceMappingURL=node_modules_%40smithy_credential-provider-imds_dist-es_index_6334b510.js.map