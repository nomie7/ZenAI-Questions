module.exports=[689960,e=>{"use strict";var t=e.i(666680);let r={randomUUID:t.randomUUID},n=new Uint8Array(256),a=n.length,o=[];for(let e=0;e<256;++e)o.push((e+256).toString(16).slice(1));e.s(["v4",0,function(e,s,i){if(r.randomUUID&&!s&&!e)return r.randomUUID();var l=e,u=i;let c=(l=l||{}).random??l.rng?.()??(a>n.length-16&&((0,t.randomFillSync)(n),a=0),n.slice(a,a+=16));if(c.length<16)throw Error("Random bytes length must be >= 16");if(c[6]=15&c[6]|64,c[8]=63&c[8]|128,s){if((u=u||0)<0||u+16>s.length)throw RangeError(`UUID byte range ${u}:${u+15} is out of buffer bounds`);for(let e=0;e<16;++e)s[u+e]=c[e];return s}return function(e,t=0){return(o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]).toLowerCase()}(c)}],689960)},905170,e=>{"use strict";async function t(t){if("gemini"===t){let{GeminiParser:t}=await e.A(595882);return new t}{let{UnstructuredParser:t}=await e.A(697443);return new t}}e.s(["getParser",()=>t])},833391,e=>e.a(async(t,r)=>{try{var n=e.i(689960),a=e.i(905170),o=e.i(983084),s=t([o]);async function i(e,t,r,s="unstructured",l){let u=l||(0,n.v4)();console.log(`Processing document: ${r} (${t}) with ${s} parser`);let c=await (0,a.getParser)(s),d=await c.parse(e,t);console.log(`Parsed ${d.metadata.pageCount} pages`);let p=await (0,o.uploadDocument)(u,e,t),g=[],h=0;for(let e of d.pages){let t="";e.imageBuffer&&(t=await (0,o.uploadPageImage)(u,e.pageNumber,e.imageBuffer));let r=function(e,t,r=500,a=50){let o=[];if(e.length<=r)return o.push({chunkId:(0,n.v4)(),text:e.trim(),pageNumber:t,chunkIndex:0,startChar:0,endChar:e.length}),o;let s=0,i=0;for(;s<e.length;){let l=s+r;if(l<e.length){let t=Math.max(l-50,s),r=e.slice(t,l),n=r.search(/[.!?]\s/);if(-1!==n)l=t+n+1;else{let e=r.lastIndexOf(" ");-1!==e&&(l=t+e)}}else l=e.length;let u=e.slice(s,l).trim();u.length>0&&(o.push({chunkId:(0,n.v4)(),text:u,pageNumber:t,chunkIndex:i,startChar:s,endChar:l}),i++);let c=Math.max(r-a,1);if((s=Math.max(l-a,s+c))>=e.length)break}return o}(e.text,e.pageNumber);h+=r.length,g.push({pageNumber:e.pageNumber,text:e.text,imageUrl:t,chunks:r})}return console.log(`Created ${h} chunks across ${g.length} pages`),{docId:u,docName:r,originalPath:p,pages:g,parserUsed:s,totalChunks:h,processedAt:new Date}}[o]=s.then?(await s)():s,e.s(["processDocument",()=>i]),r()}catch(e){r(e)}},!1),300946,e=>e.a(async(t,r)=>{try{var n=e.i(689960),a=e.i(833391),o=e.i(517903),s=e.i(328624),i=e.i(983084),l=t([a,i]);[a,i]=l.then?(await l)():l;let m=new Map,f="true"===process.env.QDRANT_SKIP_REGISTRY_SYNC||"true"===process.env.SKIP_REGISTRY_SYNC;async function u(e,t,r,l={}){let{parserType:c="unstructured",replaceDocId:d,metadata:p={}}=l,g=d||(0,n.v4)();try{await Promise.all([(0,s.ensureCollection)(),(0,i.ensureBucket)()]),m.set(g,{docId:g,docName:r,originalPath:"",pageCount:0,chunkCount:0,parserUsed:c,status:"processing",createdAt:d&&m.get(g)?.createdAt||new Date,updatedAt:new Date,metadata:p}),d&&(console.log(`Replacing document: ${d}`),await (0,s.deleteVectorsByFilter)({must:[{key:"doc_id",match:{value:d}}]}),await (0,i.deleteDocumentFiles)(d));let n=await (0,a.processDocument)(e,t,r,c,g),l=[];for(let e of n.pages)for(let t of e.chunks)l.push({chunkId:t.chunkId,text:t.text,pageNumber:e.pageNumber,chunkIndex:t.chunkIndex,imageUrl:e.imageUrl});console.log(`Generating embeddings for ${l.length} chunks...`);let u=[];for(let e=0;e<l.length;e+=100){let t=l.slice(e,e+100),n=t.map(e=>e.text),a=await (0,o.embedTexts)(n);for(let e=0;e<t.length;e++){let n=t[e];u.push({id:n.chunkId,vector:a[e],payload:{doc_id:g,doc_name:r,page_number:n.pageNumber,chunk_index:n.chunkIndex,text:n.text,image_url:n.imageUrl,parser_used:c,status:"ready",doc_type:p.docType||"unknown",topic:p.topic||"",category:p.category||"",created_at:new Date().toISOString()}})}}console.log(`Storing ${u.length} vectors in Qdrant...`),await (0,s.upsertVectors)(u);let h={docId:g,docName:r,originalPath:n.originalPath,pageCount:n.pages.length,chunkCount:n.totalChunks,parserUsed:c,status:"ready",createdAt:d&&m.get(g)?.createdAt||new Date,updatedAt:new Date,metadata:p};return m.set(g,h),console.log(`Successfully ingested document: ${r} (${g})`),{docId:g,docName:r,pageCount:n.pages.length,chunkCount:n.totalChunks,status:"ready",parserUsed:c,processedAt:new Date}}catch(t){console.error("Error ingesting document:",t);let e=m.get(g);return e&&(e.status="failed",e.updatedAt=new Date),{docId:g,docName:r,pageCount:0,chunkCount:0,status:"failed",error:t.message,parserUsed:c,processedAt:new Date}}}async function c(e){await (0,s.deleteVectorsByFilter)({must:[{key:"doc_id",match:{value:e}}]}),await (0,i.deleteDocumentFiles)(e),m.delete(e),console.log(`Deleted document: ${e}`)}async function d(){return f||0!==m.size||await h(),Array.from(m.values()).sort((e,t)=>t.updatedAt.getTime()-e.updatedAt.getTime())}function p(e){return m.get(e)}async function g(){f?console.log("Document registry init skipped (QDRANT_SKIP_REGISTRY_SYNC=true)"):(await h(),console.log("Document registry initialized from Qdrant (in-memory cache)"))}async function h(){try{let e,t=(0,s.getClient)(),r=(0,s.getCollectionName)(),n=new Map;do{let{points:a,next_page_offset:o}=await t.scroll(r,{limit:200,with_payload:!0,with_vector:!1,offset:e});for(let e of a){let t=e.payload||{},r=t.doc_id||"";if(!r)continue;let a=t.doc_name||"Untitled",o=Number(t.page_number??0),s=t.parser_used||"unstructured",i=t.status||"ready",l=t.created_at||void 0,u=l?new Date(l):new Date,c=n.get(r);c||(c={docId:r,docName:a,originalPath:"",pageCount:0,chunkCount:0,parserUsed:s,status:i,createdAt:u,updatedAt:u,metadata:t},n.set(r,c)),c.chunkCount+=1,c.pageCount=Math.max(c.pageCount,o),u<c.createdAt&&(c.createdAt=u),u>c.updatedAt&&(c.updatedAt=u)}e=o||void 0}while(void 0!==e)for(let[e,t]of(m.clear(),n.entries()))m.set(e,t)}catch(e){console.warn("Unable to sync registry from Qdrant, using in-memory only:",e.message)}}e.s(["deleteDocument",()=>c,"getDocument",()=>p,"ingestDocument",()=>u,"initializeRegistry",()=>g,"listDocuments",()=>d]),r()}catch(e){r(e)}},!1),356015,e=>e.a(async(t,r)=>{try{var n=e.i(89171),a=e.i(300946),o=t([a]);async function s(e){try{let t=await e.formData(),r=t.get("file");if(!r)return n.NextResponse.json({error:"No file provided"},{status:400});let o=t.get("docName")||r.name,s=t.get("parserType")||"unstructured";if(!["gemini","unstructured"].includes(s))return n.NextResponse.json({error:"Invalid parser type. Use 'gemini' or 'unstructured'"},{status:400});let i=t.get("replaceDocId"),l=t.get("docType"),u=t.get("topic"),c=[".pdf",".ppt",".pptx",".doc",".docx",".xls",".xlsx",".txt",".md",".html",".htm",".png",".jpg",".jpeg",".tiff",".bmp",".heic"],d=r.name.toLowerCase().substring(r.name.lastIndexOf("."));if(!c.includes(d))return n.NextResponse.json({error:`Unsupported file type: ${d}. Allowed: ${c.join(", ")}`},{status:400});let p=await r.arrayBuffer(),g=Buffer.from(p),h=await (0,a.ingestDocument)(g,r.name,o,{parserType:s,replaceDocId:i||void 0,metadata:{docType:l||void 0,topic:u||void 0,status:"ready"}});if("failed"===h.status)return n.NextResponse.json({error:h.error||"Ingestion failed",result:h},{status:500});return n.NextResponse.json({success:!0,message:i?"Document replaced successfully":"Document ingested successfully",result:h})}catch(e){return console.error("Ingestion error:",e),n.NextResponse.json({error:e.message},{status:500})}}async function i(e){try{let{searchParams:t}=new URL(e.url),r=t.get("docId");if(r){let e=(0,a.getDocument)(r);if(e||(await (0,a.initializeRegistry)(),e=(0,a.getDocument)(r)),!e)return n.NextResponse.json({error:"Document not found"},{status:404});return n.NextResponse.json({document:e})}let o=await (0,a.listDocuments)();return n.NextResponse.json({documents:o})}catch(e){return console.error("Error listing documents:",e),n.NextResponse.json({error:e.message},{status:500})}}async function l(e){try{let{searchParams:t}=new URL(e.url),r=t.get("docId");if(!r)return n.NextResponse.json({error:"docId is required"},{status:400});return await (0,a.deleteDocument)(r),n.NextResponse.json({success:!0,message:`Document ${r} deleted successfully`})}catch(e){return console.error("Error deleting document:",e),n.NextResponse.json({error:e.message},{status:500})}}[a]=o.then?(await o)():o,e.s(["DELETE",()=>l,"GET",()=>i,"POST",()=>s]),r()}catch(e){r(e)}},!1),208492,e=>e.a(async(t,r)=>{try{var n=e.i(747909),a=e.i(174017),o=e.i(996250),s=e.i(759756),i=e.i(561916),l=e.i(114444),u=e.i(837092),c=e.i(869741),d=e.i(316795),p=e.i(487718),g=e.i(995169),h=e.i(47587),m=e.i(666012),f=e.i(570101),w=e.i(626937),y=e.i(10372),R=e.i(193695);e.i(52474);var v=e.i(600220),x=e.i(356015),C=t([x]);[x]=C.then?(await C)():C;let E=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/ingest/route",pathname:"/api/ingest",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/ingest/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:N,workUnitAsyncStorage:I,serverHooks:_}=E;function D(){return(0,o.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:I})}async function A(e,t,r){E.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/ingest/route";n=n.replace(/\/index$/,"")||"/";let o=await E.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:x,params:C,nextConfig:D,parsedUrl:A,isDraftMode:N,prerenderManifest:I,routerServerContext:_,isOnDemandRevalidate:b,revalidateOnlyGenerated:U,resolvedPathname:k,clientReferenceManifest:T,serverActionsManifest:P}=o,S=(0,c.normalizeAppPath)(n),$=!!(I.dynamicRoutes[S]||I.routes[k]),O=async()=>((null==_?void 0:_.render404)?await _.render404(e,t,A,!1):t.end("This page could not be found"),null);if($&&!N){let e=!!I.routes[k],t=I.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(D.experimental.adapterPath)return await O();throw new R.NoFallbackError}}let j=null;!$||E.isDev||N||(j=k,j="/index"===j?"/":j);let M=!0===E.isDev||!$,H=$&&!M;P&&T&&(0,l.setReferenceManifestsSingleton)({page:n,clientReferenceManifest:T,serverActionsManifest:P,serverModuleMap:(0,u.createServerModuleMap)({serverActionsManifest:P})});let q=e.method||"GET",F=(0,i.getTracer)(),B=F.getActiveScopeSpan(),K={params:C,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!D.experimental.authInterrupts},cacheComponents:!!D.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:D.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>E.onRequestError(e,t,n,_)},sharedContext:{buildId:x}},L=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),V=p.NextRequestAdapter.fromNodeNextRequest(L,(0,p.signalFromNodeResponse)(t));try{let o=async e=>E.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==g.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${n}`)}),l=!!(0,s.getRequestMeta)(e,"minimalMode"),u=async s=>{var i,u;let c=async({previousCacheEntry:a})=>{try{if(!l&&b&&U&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(s);e.fetchMetrics=K.renderOpts.fetchMetrics;let i=K.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let u=K.renderOpts.collectedTags;if(!$)return await (0,m.sendResponse)(L,G,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[y.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:b})},_),t}},d=await E.handleResponse({req:e,nextConfig:D,cacheKey:j,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:U,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:l});if(!$)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",b?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&$||p.delete(y.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,w.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(L,G,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};B?await u(B):await F.withPropagatedContext(e.headers,()=>F.trace(g.BaseServerSpan.handleRequest,{spanName:`${q} ${n}`,kind:i.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},u))}catch(t){if(t instanceof R.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:b})}),$)throw t;return await (0,m.sendResponse)(L,G,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>D,"routeModule",()=>E,"serverHooks",()=>_,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>I]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_25c1598d._.js.map